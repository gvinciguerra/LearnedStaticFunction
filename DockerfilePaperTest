FROM ubuntu:24.04

RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    libboost-regex-dev \
    libsqlite3-dev \
    texlive-full \
    && apt-get clean



############################ Build sqlplot-tools ############################
COPY paper /paper

RUN git clone https://github.com/bingmann/sqlplot-tools.git /opt/sqlplot-tools
RUN mkdir /opt/sqlplot-tools/build
WORKDIR /opt/sqlplot-tools/build
RUN cmake -DCMAKE_BUILD_TYPE=Release -DWITH_POSTGRESQL=OFF -DWITH_MYSQL=OFF ..
RUN cmake --build . -j 8

############################ Execute ############################
RUN echo '#!/bin/bash\n\
set -e\n\
cd /paper/fig\n\
for f in $(find . -name "*.tex"); do\n\
    echo -e "\n\n--- Building $f"\n\
    /opt/sqlplot-tools/build/src/sqlplot-tools "$f" || exit 1\n\
done\n\
cd /paper\n\
pdflatex main.tex\n\
bibtex main\n\
pdflatex main.tex\n\
pdflatex main.tex\n\
cp main.pdf /out/' > entrypoint.sh

ENTRYPOINT ["/bin/bash", "./entrypoint.sh"]
